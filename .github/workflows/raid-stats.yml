name: Generate Raid Stats

on:
  schedule:
    # Run twice weekly: Wednesday 9am UTC and Sunday 9am UTC
    - cron: '0 9 * * 2,0'
  workflow_dispatch: # Allow manual runs

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow pushing to gh-pages
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      run: |
        echo "WARCRAFTLOGS_CLIENT_ID=${{ secrets.WARCRAFTLOGS_CLIENT_ID }}" >> .env
        echo "WARCRAFTLOGS_CLIENT_SECRET=${{ secrets.WARCRAFTLOGS_CLIENT_SECRET }}" >> .env
        echo "GUILD_NAME=Limeknighters" >> .env
        echo "GUILD_REALM=Frostmourne" >> .env
        echo "GUILD_REGION=us" >> .env
        echo "RAID_TEAM_FILTER=vkf00" >> .env
        echo "WARCRAFTLOGS_API_URL=https://www.warcraftlogs.com/api/v2/client" >> .env
        echo "DATABASE_PATH=raid_stats.db" >> .env
        echo "SLIDES_DIR=slides" >> .env
        echo "OUTPUT_DIR=output" >> .env
        echo "DIFFICULTY_FILTER=3" >> .env
    
    - name: Generate raid stats
      run: python main.py
    
    - name: Prepare deployment
      run: |
        mkdir -p deploy
        cp slideshow.html deploy/
        cp -r slides deploy/
        [ -f guild-logo.webp ] && cp guild-logo.webp deploy/ || true
        touch deploy/.nojekyll
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy  # <-- Changed from ./
        force_orphan: true
    
    - name: Post to Discord
      if: success()
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/slideshow.html"
        curl -H "Content-Type: application/json" \
             -d "{\"content\": \"ðŸ“Š **New Raid Stats Posted!**\n\nðŸ”— View the stats: $PAGES_URL\n\nâœ¨ Updated: $(date '+%Y-%m-%d %H:%M UTC')\"}" \
             $DISCORD_WEBHOOK
